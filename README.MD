Este documento explica o fluxo de trabalho do projeto.

## ğŸ¯ VisÃ£o Geral

O projeto Ã© composto por uma aplicaÃ§Ã£o em PHP 8 e MYSQL 8.0 se tratando de categorias e produtos, onde cada produto precisa ter uma categoria (ambos com CRUD completo).

O cÃ³digo se encontra no GitHub que Ã© utilizado para testes e deploy.

O projeto usa um fluxo de CI/CD automatizado com duas branches principais:
- **develop**: Branch de desenvolvimento
- **master**: Branch de produÃ§Ã£o

## ğŸ”„ Fluxo de Trabalho

### 1. Desenvolvimento de Features

```bash
# Criar nova branch a partir de develop
git clone https://github.com/ferpslva/New-Devops.git
Fazer um pull na branch develop
Criar uma nova branch
Utilizar a IDE VSCode para alteraÃ§Ãµes
Selecionar os itens alterados e fazer um commit

### 2. Pull Request para Develop

1. **Abrir PR** no GitHub:
   - Importante que a PR seja da branch criada para develop
2. **CI executa automaticamente**:
3. **Aguardar resultado**:
   - âœ… Verde = Pode fazer merge
   - âŒ Vermelho = Corrigir problemas e push novamente

### 3. Merge em Develop

# ApÃ³s aprovaÃ§Ã£o e CI passar
# Fazer merge do PR no GitHub
# âš ï¸ NENHUM deploy acontece aqui!
```

### 4. Deploy em ProduÃ§Ã£o

Quando estiver pronto para produÃ§Ã£o:

```bash
# Criar PR de develop para master
# No GitHub: develop â†’ master
```

1. **CI valida novamente**
2. **Aguardar aprovaÃ§Ã£o para autorizar a merge**
3. **CD deploy automÃ¡tico** ğŸš€
   - Sincroniza cÃ³digo para VPS
   - Backup do banco de dados
   - Rebuild dos containers
   - Health check da aplicaÃ§Ã£o

---

## ğŸ›¡ï¸ ProteÃ§Ãµes

### Branch `develop`
- âœ… CI obrigatÃ³rio antes de merge
- âœ… Testes devem passar
- âœ… Build Docker deve compilar

### Branch `master`
- âœ… CI obrigatÃ³rio antes de merge
- âœ… Todos os checks devem passar
- ğŸš€ Deploy automÃ¡tico apÃ³s merge

---

## ğŸ§ª CI - IntegraÃ§Ã£o ContÃ­nua

### O que o CI valida:

1. **Testes UnitÃ¡rios e de IntegraÃ§Ã£o**
   - Executa PHPUnit
   - Testa CRUD completo
   - Valida integraÃ§Ã£o com MySQL

2. **Build Docker**
   - Valida que o Dockerfile compila
   - Garante que a imagem pode ser construÃ­da

3. **Schema SQL**
   - Valida estrutura do banco
   - Cria tabelas de teste
   - Garante compatibilidade

### Quando o CI executa:
- âœ… Todo PR para `develop`
- âœ… Todo PR para `master`

---

## ğŸš€ CD - Deploy ContÃ­nuo

### O que o CD faz:

1. **SincronizaÃ§Ã£o de CÃ³digo**
   - rsync completo para `/opt/sistema_av_iii/`
   - Exclui: .git, node_modules, vendor, backups

2. **Backup do Banco**
   - Mysqldump automÃ¡tico
   - MantÃ©m Ãºltimos 7 backups

3. **Deploy dos Containers**
   - Para containers antigos
   - Rebuild com novo cÃ³digo
   - Restart automÃ¡tico

4. **Health Check**
   - Verifica se aplicaÃ§Ã£o estÃ¡ respondendo
   - 10 tentativas com 5s de intervalo
   - Falha se nÃ£o responder

### Quando o CD executa:
- âœ… Apenas em push/merge para `master`
- âŒ Nunca em develop ou outras branches

---

## ğŸ“Š Status dos Workflows

### CI
Os PRs mostrarÃ£o um dos seguintes status:
- ğŸŸ¢ **Success**: Todos os checks passaram â†’ Pode fazer merge
- ğŸ”´ **Failed**: Algum check falhou â†’ Corrigir antes de merge
- ğŸŸ¡ **Running**: CI em execuÃ§Ã£o â†’ Aguardar

### CD
ApÃ³s merge em master:
- ğŸŸ¢ **Success**: Deploy completado com sucesso
- ğŸ”´ **Failed**: Deploy falhou

---

## ğŸ” Troubleshooting

### Em caso de falhas no CI/CD:
1. Verificar logs no GitHub Actions

## ğŸŒ URLs

- **ProduÃ§Ã£o**: http://191.252.204.148:8080

---

## ğŸ“ Boas PrÃ¡ticas

1. âœ… Sempre criar feature branches
2. âœ… Escrever mensagens de commit descritivas
3. âœ… NÃ£o fazer push direto em develop ou master
4. âœ… Usar PRs mesmo para pequenas mudanÃ§as

---

# Monitoramento utilizando Grafana e Dozzle

## ğŸ¯ VisÃ£o Geral

1. **Grafana Cloud** - Dashboard profissional com mÃ©tricas e logs histÃ³ricos
2. **Dozzle** - Interface web para logs em tempo real


### 2. Configurar Grafana Cloud (MÃ©tricas + Logs)

#### Passo 1: Criar conta gratuita
#### Passo 2: Obter credenciais do Prometheus
#### Passo 3: Instalar Grafana Alloy no VPS

## ğŸ–¥ï¸ Como Acessar

### ğŸ“Š Grafana Cloud (Dashboard Principal)

**URL**: https://[seu-stack].grafana.net
**O que vocÃª vÃª**:
- MÃ©tricas do servidor (CPU, RAM, Disco, Rede)
- Logs dos containers (Nginx, PHP, MySQL)

#### Navegando no Grafana:

**1. Ver MÃ©tricas:**
- Queries Ãºteis:
  ```
  up                                 # Servidor online (1 = sim, 0 = nÃ£o)
  node_cpu_seconds_total             # CPU por core
  node_memory_MemAvailable_bytes     # RAM disponÃ­vel
  ```

**2. Ver Logs:**
- Queries Ãºteis:
  ```
  {container="mvc_app_web"}              # Logs do Nginx
  {container="mvc_app_php"}              # Logs do PHP
  {container="mvc_app_db"}               # Logs do MySQL
  {container=~".+"} |= "error"           # Todos os erros
  ```

**Dozzle**
Dozzle Ã© deployado automaticamente pelo CD
Sempre que vocÃª fizer push em `master`, o workflow de CD:
1. Faz deploy da aplicaÃ§Ã£o
2. **Sobe o Dozzle automaticamente**

**Acesso**: http://191.252.204.148:9999


### ğŸ“ Dozzle (Logs em Tempo Real)

**URL**: http://191.252.204.148:9999
**O que vocÃª vÃª**:
- Lista de todos os containers rodando
- Logs em tempo real (live streaming)

## ğŸ“Š MÃ©tricas Importantes

### CPU Usage

**Limites:**
- **Normal**: < 70%
- **Alerta**: > 80%
- **CrÃ­tico**: > 90%

### MemÃ³ria

**Limites:**
- **Normal**: > 200MB disponÃ­vel
- **Alerta**: < 150MB disponÃ­vel
- **CrÃ­tico**: < 100MB disponÃ­vel

---

## Possibilidade de Configurar Alertas e Dashboards personalizados

## Custos

- **Dozzle**: GrÃ¡tis
- **Grafana Cloud**: GrÃ¡tis
- **Grafana Alloy**: GrÃ¡tis
- **Logs Nativos**: GrÃ¡tis

**Total: R$ 0,00**

---

Ãšltima atualizaÃ§Ã£o: 05/11/2025
